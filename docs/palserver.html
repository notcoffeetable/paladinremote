<!DOCTYPE html>

<html>
<head>
  <title>palserver.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>palserver.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class="highlight"><pre>&#x2F;*
* Initial working but messy server code.
*
* Copyright 2012. Paladin Innovators LLC. All rights reserved.
*&#x2F;
var http = require(&#x27;http&#x27;);
var fs = require(&#x27;fs&#x27;);
var url = require(&#x27;url&#x27;);
var sys = require(&#x27;sys&#x27;)
var exec = require(&#x27;child_process&#x27;).exec;
var mdns = require(&#x27;mdns&#x27;);
var child;

var advertiseServer = mdns.createAdvertisement(mdns.tcp(&#x27;paladin-remote&#x27;), 1337, function(err, service) {
      if (err) {
        console.log(&#x27;ERROR:&#x27;, err);
      } else {
        console.log(service);
      }
    });
advertiseServer.start();

http.createServer(function (req, res) {
    var reqUrl = url.parse(req.url).pathname;
    var _GET = url.parse(req.url, true).query;
    var params = &quot;&quot;;

    if(&quot;&#x2F;&quot; == reqUrl)
        reqUrl += &quot;index.html&quot;;

    if(1 == reqUrl.split(&quot;.&quot;).length)
        reqUrl += &quot;.pl&quot;;

    if(undefined != _GET) {
        for (p in _GET) {
</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              
<p>_ is used by jQuery to hack IE caching, not a value you
care about passing to perl.</p>

            </div>
            
            <div class="content"><div class="highlight"><pre>            if(&quot;_&quot; == p)
                continue;
            console.log(p + &quot; : &quot; + _GET[p]);
            params += &quot; &quot; + _GET[p];
        }
    }

    if(fs.exists(&quot;.&quot; + reqUrl, function (exists) {
        if(exists &amp;&amp; (&quot;pl&quot; != reqUrl.split(&quot;.&quot;)[1])) {
            fs.readFile(&quot;.&quot; + reqUrl, function (err, data) {
                if(!err) {
                    res.end(data);
                }else{
                    res.writeHead(500, {&#x27;Content-Type&#x27;: &#x27;text&#x2F;html&#x27;});
                    res.end(&#x27;Five hundred: something done broke!&#x27;);
                    console.log(err);
                }
            });
        } else if (exists &amp;&amp; (&quot;pl&quot; == reqUrl.split(&quot;.&quot;)[1])) {
            console.log(&quot;perl .&quot; + reqUrl + params);
            child = exec(&quot;perl .&quot; + reqUrl + params, function (error, stdout, stderr) {
</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
<pre><code>         sys.print(stdout);</code></pre>

            </div>
            
            <div class="content"><div class="highlight"><pre>                var perlResponse = stdout.split(&quot;\n&quot;);
                if(perlResponse.length &gt; 1) {
</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              
<pre><code>             console.log(perlResponse[1] + &quot;\n&quot;);</code></pre>

            </div>
            
            <div class="content"><div class="highlight"><pre>                    res.writeHead(200, {&#x27;content-type&#x27;: &#x27;text&#x2F;json&#x27;});
                    res.end(JSON.stringify(perlResponse));
                }else{
                    res.end();
                }
</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              
<pre><code>           sys.print(&#39;stderr: &#39; + stderr);</code></pre>

            </div>
            
            <div class="content"><div class="highlight"><pre>                if (error !== null) {
                    console.log(&#x27;exec error: &#x27; + error);
                }
            });          
        } else {
            res.writeHead(404, {&#x27;Content-Type&#x27;: &#x27;text&#x2F;html&#x27;});
            res.end(&#x27;Four oh Four!&#x27;);
        }
    }));

}).listen(1337);
console.log(&#x27;Server running...\n&#x27;);

</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
